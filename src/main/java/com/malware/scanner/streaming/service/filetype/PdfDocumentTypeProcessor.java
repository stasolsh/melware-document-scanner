package com.malware.scanner.streaming.service.filetype;

import com.malware.scanner.streaming.dao.BlacklistedIbanDao;
import com.malware.scanner.streaming.exception.ScannerTechnicalException;
import com.malware.scanner.streaming.model.CheckEvent;
import com.malware.scanner.streaming.model.CheckResultEvent;
import com.malware.scanner.streaming.model.FileType;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;

import static com.malware.scanner.streaming.model.CheckResultEvent.StateEnum.*;
import static com.malware.scanner.streaming.model.FileType.PDF;
import static com.malware.scanner.streaming.utils.GetIbansFromPDF.findIbans;
import static java.util.stream.Collectors.joining;

@Service
@RequiredArgsConstructor
public class PdfDocumentTypeProcessor implements DocumentTypeProcessor {
    private final BlacklistedIbanDao blacklistedIbanDao;

    @Override
    public CheckResultEvent verify(final CheckEvent checkEvent, final String name) {
        CheckResultEvent checkResultEvent = new CheckResultEvent().setName(name);
        try {
            List<String> ibans = findIbans(checkEvent.getUrl());
            checkResultEvent.setState(buildState(ibans, checkResultEvent));
        } catch (ScannerTechnicalException e) {
            checkResultEvent.setState(ERROR);
            checkResultEvent.setDetails(e.getCause().toString());
        }
        return checkResultEvent;
    }

    private CheckResultEvent.StateEnum buildState(List<String> ibans, CheckResultEvent checkResultEvent) {
        CheckResultEvent.StateEnum stateEnum;
        if (blacklistedIbanDao.existsByIbanCodeIn(ibans)) {
            stateEnum = SUSPICIOUS;
            String blacklistedIbans = ibans.stream().filter(blacklistedIbanDao::existsByIbanCode).collect(joining(","));
            checkResultEvent.setDetails("There are blacklisted IBAN's: " + blacklistedIbans);
        } else {
            stateEnum = OK;
            checkResultEvent.setDetails("There are not blacklisted IBAN's.");
        }
        return stateEnum;
    }

    @Override
    public FileType getDocType() {
        return PDF;
    }
}
